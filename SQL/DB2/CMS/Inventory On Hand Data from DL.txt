SELECT
	X.PERD,
	YACOMP||DIGITS(Y1INVA) ACCT, 
	SUBSTR(YACOMP||DIGITS(Y1INVA),7,4) PRIME,
	BYPLNT PLANT, 
	RTRIM(BYPART)||' - '||RTRIM(COALESCE(AVDES1,AWDES1,'')) PART, 
	BYSTOK||' - '||RTRIM(AXLOCN) ILOC,
	MODULE,
	COALESCE(AWGLDC, AVGLCD) GLCODE,
	COALESCE(AWGLED, AVGLED) INVCODE,
	COALESCE(AWMAJG,AVMAJG)||' - '||RTRIM(BQDES) MAJG,
	COALESCE(AWMING, AVMING)||' - '||RTRIM(BRDES)  MING,
	COALESCE(AWMAJS, AVMAJS)||' - '||RTRIM(SMJ.BSDES1) MAJS,
	COALESCE(AWMINS, AVMINS)||' - '||RTRIM(SMN.BSDES1) MINS,
	V6STAT STATUS, 
	V6RPLN PROCUREMENT,
	SUM(QTOH) QTOH,
	SUM(EXTCOST) EXTCOST,
	SUM(EXTCOST*CASE SUBSTR(BYPLNT,1,2) WHEN '11' THEN BS ELSE 1 END) EXTCOST_USD
FROM
(
SELECT
	SUBSTR(BYFSYY,3,2)||DIGITS(BYFSPR) PERD, BYPLNT, BYPART, BYSTOK,
	CASE STKT.BYSRC 
		WHEN 'OE' THEN  'OE'||UPPER(SUBSTRING(BYDREF,1,3)) 
		WHEN 'INV' THEN 'INV'||RTRIM(BYREAS)
		ELSE BYSRC 
	END AS MODULE,
	-SUM(BYQTY*CASE BYACTN WHEN 'I' THEN -1 ELSE 1 END) QTOH,
	-SUM(BYQTY*CASE BYACTN WHEN 'I' THEN -1 ELSE 1 END*COALESCE(FCOST, CGSTCS, CHSTCS, Y0STCS)) EXTCOST
FROM
	LGDAT.STKT STKT
	LEFT OUTER JOIN QGPL.FFCOSTEFFD ON
		PART = BYPART AND
		PLNT = BYPLNT AND
		CHAR(FDT)||CHAR(FTM) < CHAR(BYSDAT)||CHAR(BYSTIM) AND
		CHAR(TDT)||CHAR(TTM) > CHAR(BYSDAT)||CHAR(BYSTIM)
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = BYPART AND
		CGPLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = BYPART AND
		CHPLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = BYPART AND
		Y0PLNT = BYPLNT
WHERE
	BYFSYY||DIGITS(BYFSPR) >= '201502'
GROUP BY
	SUBSTR(BYFSYY,3,2)||DIGITS(BYFSPR), 
	BYPLNT, BYPART, BYSTOK,
	CASE STKT.BYSRC 
		WHEN 'OE' THEN  'OE'||UPPER(SUBSTRING(BYDREF,1,3)) 
		WHEN 'INV' THEN 'INV'||RTRIM(BYREAS)
		ELSE BYSRC 
	END

UNION ALL

SELECT
	'CURR' PERD, BXPLNT BYPLNT, BXPART BYPART, BXSTOK BYSTOK,
	'CURR' MODULE,
	SUM(BXQTOH) QTOH,
	SUM(BXQTOH*COALESCE(CGSTCS, CHSTCS, Y0STCS)) EXTCOST
FROM
	LGDAT.STKB
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = BXPART AND
		CGPLNT = BXPLNT
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = BXPART AND
		CHPLNT = BXPLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = BXPART AND
		Y0PLNT = BXPLNT
WHERE
	BXPART <> '' AND
	BXQTOH<> 0
GROUP BY
	BXPLNT, BXPART, BXSTOK
) X
LEFT OUTER JOIN LGDAT.STKA ON
	V6PART = BYPART AND
	V6PLNT = BYPLNT
LEFT OUTER JOIN LGDAT.STKMM ON
	AVPART = BYPART
LEFT OUTER JOIN LGDAT.STKMP ON
	AWPART = BYPART
LEFT OUTER JOIN LGDAT.PLNT ON
	YAPLNT = BYPLNT
LEFT OUTER JOIN LGDAT.GLIE ON
	Y1PLNT = BYPLNT AND
	Y1GLEC = COALESCE(AVGLED, AWGLED)
LEFT OUTER JOIN LGDAT.MAJG ON
	BQGRP = COALESCE(AWMAJG, AVMAJG)
LEFT OUTER JOIN LGDAT.MMGP ON
	BRGRP = BQGRP AND
	BRMGRP = COALESCE(AVMING, AWMING)
LEFT OUTER JOIN LGDAT.MMSL SMN ON
	SMN.BSMJCD = COALESCE(AVMAJS, AWMAJS) AND
	SMN.BSMNCD = COALESCE(AVMINS, AWMINS)
LEFT OUTER JOIN LGDAT.MMSL SMJ ON
	SMJ.BSMJCD = COALESCE(AVMAJS, AWMAJS) AND
	SMJ.BSMNCD = ''
LEFT OUTER JOIN LGDAT.STKR ON
	AXSTKL = BYSTOK
LEFT OUTER JOIN QGPL.FFFX FX ON
	FX.PERD = '1501'
GROUP BY
	X.PERD,
	YACOMP||DIGITS(Y1INVA),
	SUBSTR(YACOMP||DIGITS(Y1INVA),7,4),
	BYPLNT, RTRIM(BYPART)||' - '||RTRIM(COALESCE(AVDES1,AWDES1,'')), 
	BYSTOK||' - '||RTRIM(AXLOCN),
	MODULE,
	COALESCE(AWGLDC, AVGLCD),
	COALESCE(AWGLED, AVGLED),
	COALESCE(AWMAJG,AVMAJG)||' - '||RTRIM(BQDES),
	COALESCE(AWMING, AVMING)||' - '||RTRIM(BRDES),
	COALESCE(AWMAJS, AVMAJS)||' - '||RTRIM(SMJ.BSDES1),
	COALESCE(AWMINS, AVMINS)||' - '||RTRIM(SMN.BSDES1),
	V6STAT, V6RPLN